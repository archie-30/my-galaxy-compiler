<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>C++ Galaxy Compiler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --editor-font-size: 14px;
            --problem-font-size: 14px;
            
            /* Syntax Colors - Modern Style (Default) */
            --syntax-keyword: #569cd6;      /* Blue */
            --syntax-operator: #d4d4d4;
            --syntax-variable: #9cdcfe;
            --syntax-def: #dcdcaa;
            --syntax-type: #4ec9b0;         /* Teal/Greenish (Type color) */
            --syntax-builtin: #4ec9b0;
            --syntax-number: #b5cea8;
            --syntax-atom: #b5cea8;
            --syntax-string: #ce9178;
            --syntax-comment: #6a9955;
            --syntax-meta: #c586c0;
            
            --bg-color: #1e1e1e;
            --text-color: #d4d4d4;
            --border-color: #333;
            /* Slightly lighter selection bg for better visibility */
            --selection-bg: #264f78;
            --selection-border: rgba(255, 255, 255, 0.3);
            
            --ease-spring: cubic-bezier(0.4, 0.0, 0.2, 1);
            --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        [data-theme="classic"] {
            /* Syntax Colors - Classic Style */
            --syntax-keyword: #f08d49;
            --syntax-operator: #f08d49;
            --syntax-variable: #d4d4d4;
            --syntax-def: #f8f8f2;
            --syntax-type: #8be9fd;         /* Light Blue (Type color) */
            --syntax-builtin: #f8f8f2;      /* White for cin/cout */
            --syntax-number: #bd93f9;
            --syntax-atom: #bd93f9;
            --syntax-string: #f1fa8c;
            --syntax-comment: #6272a4;
            --syntax-meta: #f08d49;
            
            --selection-bg: #3e4451;
            --selection-border: rgba(255, 255, 255, 0.4);
        }

        /* 保留：強化 html 和 body 的鎖定，防止滾動 */
        html {
            height: 100%;
            width: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            height: 100%; 
            width: 100%; 
            position: fixed; /* 強制定位 */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden; 
            transition: background-color 0.3s var(--ease-spring), color 0.3s var(--ease-spring);
        }

        .CodeMirror { 
            height: 100% !important; 
            width: 100% !important; 
            font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace !important;
            font-size: var(--editor-font-size); 
            font-variant-ligatures: none !important;
            font-feature-settings: "liga" 0, "calt" 0 !important;
            transition: opacity 0.2s var(--ease-spring);
        }
        
        .CodeMirror-matchingbracket { box-shadow: 0 0 0 1px rgba(255, 215, 0, 0.8); background-color: rgba(255, 215, 0, 0.25); color: inherit !important; }
        .CodeMirror-nonmatchingbracket { box-shadow: 0 0 0 1px rgba(255, 68, 68, 0.8); background-color: rgba(255, 68, 68, 0.2); }

        .cm-matchhighlight { background-color: #3a3a3a; border-bottom: 1px solid rgba(255, 255, 255, 0.15); }
        
        /* Exclude types from gray highlight */
        .cm-matchhighlight.cm-keyword, 
        .cm-matchhighlight.cm-string, 
        .cm-matchhighlight.cm-comment,
        .cm-matchhighlight.cm-builtin,
        .cm-matchhighlight.cm-type,
        .cm-matchhighlight.cm-string-type
        { 
            background-color: transparent !important; 
            border-bottom: none !important; 
        }
        [data-theme="classic"] .cm-matchhighlight { background-color: #454952; }
        [data-theme="classic"] .cm-matchhighlight.cm-keyword, 
        [data-theme="classic"] .cm-matchhighlight.cm-string, 
        [data-theme="classic"] .cm-matchhighlight.cm-comment,
        [data-theme="classic"] .cm-matchhighlight.cm-builtin,
        [data-theme="classic"] .cm-matchhighlight.cm-type,
        [data-theme="classic"] .cm-matchhighlight.cm-string-type {
            background-color: transparent !important;
            border-bottom: none !important;
        }

        .cm-s-cloudjudge.CodeMirror { background-color: var(--bg-color); color: var(--text-color); }
        .cm-s-cloudjudge .CodeMirror-gutters { background: var(--bg-color); color: #858585; border: none; transition: background-color 0.3s var(--ease-spring); }
        .cm-s-cloudjudge .CodeMirror-linenumber { color: #858585; }
        .cm-s-cloudjudge .CodeMirror-cursor { border-left: 2px solid #f8f8f0; }
        .cm-s-cloudjudge div.CodeMirror-selected { background: var(--selection-bg); transition: background-color 0.3s var(--ease-spring); }
        .cm-s-cloudjudge .CodeMirror-line::selection, .cm-s-cloudjudge .CodeMirror-line > span::selection { background: var(--selection-bg); }
        
        .CodeMirror-selected { outline: 1px solid var(--selection-border); }
        
        /* Syntax Highlighting */
        .cm-s-cloudjudge .cm-keyword { color: var(--syntax-keyword) !important; font-weight: bold; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-operator { color: var(--syntax-operator) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-variable { color: var(--syntax-variable) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-variable-2 { color: var(--syntax-variable) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-variable-3 { color: var(--syntax-type) !important; font-weight: bold; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-type { color: var(--syntax-type) !important; font-weight: bold; transition: color 0.3s; }
        
        .cm-s-cloudjudge .cm-string-type { color: var(--syntax-type) !important; font-weight: bold; transition: color 0.3s; } 
        
        .cm-s-cloudjudge .cm-builtin { color: var(--syntax-builtin) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-atom { color: var(--syntax-atom) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-number { color: var(--syntax-number) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-def { color: var(--syntax-def) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-string { color: var(--syntax-string) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-meta { color: var(--syntax-meta) !important; transition: color 0.3s; }
        .cm-s-cloudjudge .cm-comment { color: var(--syntax-comment) !important; font-style: italic; transition: color 0.3s; }

        .cm-s-cloudjudge .cm-indent-guides {
            display: inline-block;
            background-image: linear-gradient(to right, var(--bg-color) 4ch, transparent 4ch), repeating-linear-gradient(to right, #404040 0, #404040 1px, transparent 1px, transparent 4ch);
            background-position: 0 0; background-repeat: no-repeat; background-size: 100% 100%; transition: background-image 0.3s;
        }

        [data-theme="classic"] .cm-s-cloudjudge .cm-indent-guides {
             background-image: linear-gradient(to right, var(--bg-color) 4ch, transparent 4ch), repeating-linear-gradient(to right, #505050 0, #505050 1px, transparent 1px, transparent 4ch);
        }

        .CodeMirror-hints { background: #252526; border: 1px solid #454545; color: #d4d4d4; }
        li.CodeMirror-hint-active { background: #007acc; color: white; }

        .resizer-split {
            flex: none; background-color: transparent; z-index: 20; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; position: relative; touch-action: none;
        }
        .resizer-split::after { content: ''; position: absolute; background-color: #333; transition: all 0.2s; pointer-events: none; }
        .resizer-split.resizer-col { width: 16px; cursor: col-resize; margin: 0 -8px; }
        .resizer-split.resizer-col::after { width: 1px; height: 100%; top: 0; }
        .resizer-split.resizer-row { height: 16px; cursor: row-resize; margin: -8px 0; }
        .resizer-split.resizer-row::after { width: 100%; height: 1px; left: 0; }
        .resizer-split:hover::after, .resizer-split.resizing::after { background-color: #007acc; box-shadow: 0 0 6px rgba(0, 122, 204, 0.4); }
        .resizer-split.resizer-col:hover::after, .resizer-split.resizer-col.resizing::after { width: 4px; }
        .resizer-split.resizer-row:hover::after, .resizer-split.resizer-row.resizing::after { height: 4px; }

        .toolbar-btn { padding: 4px; border-radius: 4px; transition: all 0.2s; position: relative; overflow: hidden; }
        .toolbar-btn:hover { background-color: #3e4451; color: #fff; transform: translateY(-1px); }
        .toolbar-btn:active { transform: scale(0.95); }
        .toolbar-separator { width: 1px; height: 16px; background-color: #454545; margin: 0 4px; }

        .terminal-cursor { display: inline-block; width: 8px; height: 16px; background-color: #d4d4d4; animation: blink 1s step-end infinite; vertical-align: middle; }
        @keyframes blink { 50% { opacity: 0; } }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; transition: all 0.3s; }
        .status-connected { background-color: #4ade80; box-shadow: 0 0 8px #4ade80; }
        .status-disconnected { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
        
        .terminal-input-echo { color: #4ade80; font-weight: bold; }
        .terminal-error { color: #f87171; font-weight: bold; }
        .terminal-warning { color: #fbbf24; font-weight: bold; }
        .terminal-note { color: #60a5fa; }
        .terminal-path { color: #a3a3a3; text-decoration: underline; }
        
        #terminal-container { font-family: Consolas, monospace !important; scroll-behavior: smooth; }
        #terminal-input { font-family: Consolas, monospace !important; transition: border-color 0.2s; }

        /* Unified Toggle Style (Both for Theme and Side Panel) */
        .toggle-container-base { display: flex; background-color: #3c3c3c; border-radius: 6px; padding: 2px; position: relative; cursor: pointer; border: 1px solid #333; }
        .toggle-bg-base { position: absolute; top: 2px; left: 2px; height: 22px; background-color: #007acc; border-radius: 4px; transition: transform 0.4s var(--ease-bounce), background-color 0.3s; }
        .toggle-option-base { flex: 1; text-align: center; font-size: 11px; font-weight: bold; color: #ccc; z-index: 10; line-height: 24px; transition: color 0.3s; letter-spacing: 0.05em; }
        .toggle-option-base.active { color: white; }

        /* Side Panel Toggle Specifics */
        .side-panel-toggle { width: 140px; height: 24px; margin-right: 0; } 
        .side-panel-toggle .side-toggle-bg { width: 68px; height: 20px; top: 2px; } 
        .side-panel-toggle.show-desc .side-toggle-bg { transform: translateX(68px); }
        .side-panel-toggle .toggle-option-base { line-height: 20px; font-size: 11px; }

        .dropdown-container { position: relative; display: inline-block; font-size: 12px; font-weight: bold; color: white; user-select: none; }
        .dropdown-trigger { display: flex; align-items: center; justify-content: space-between; gap: 6px; background-color: #3c3c3c; border: 1px solid #333; border-radius: 4px; padding: 4px 10px; cursor: pointer; min-width: 115px; transition: all 0.3s; }
        .dropdown-trigger:hover { background-color: #454545; transform: translateY(-2px); border-color: #666; }
        .dropdown-menu { position: absolute; top: calc(100% + 6px); left: 0; width: 100%; background-color: #252526; border: 1px solid #454545; border-radius: 6px; padding: 4px; z-index: 100; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; }
        .dropdown-container.open .dropdown-menu { opacity: 1; visibility: visible; transform: translateY(0); }
        .dropdown-item { padding: 6px 10px; cursor: pointer; border-radius: 4px; color: #ccc; font-weight: normal; display: flex; justify-content: space-between; align-items: center; }
        .dropdown-item:hover { background-color: #007acc; color: white; }
        .dropdown-item.selected { color: #fff; background-color: rgba(255, 255, 255, 0.1); font-weight: bold; }
        /* Dropdown Disabled State */
        .dropdown-item.disabled { color: #666; cursor: not-allowed; background-color: transparent !important; }
        .dropdown-item.disabled svg { color: #555; }
        
        .dropdown-label { font-size: 10px; text-transform: uppercase; color: #666; padding: 4px 10px; pointer-events: none; margin-top: 4px; }
        
        /* New Settings Btn Style with Absolute Icon & Centered Text */
        .settings-btn { 
            padding: 6px 8px 6px 30px; /* Left padding space for icon */
            background-color: #3c3c3c; 
            border: 1px solid #333; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: all 0.2s; 
            color: #ccc; 
            height: 30px; 
            position: relative; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            min-width: 90px;
        }
        .settings-btn:hover, .dropdown-container.open .settings-btn { background-color: #454545; color: white; border-color: #555; }
        .settings-btn svg { position: absolute; left: 8px; }

        /* FIXED: Problem Settings Button Style */
        .problem-settings-btn {
            /* Reset/Override dropdown-trigger defaults if present */
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            position: relative !important;
            
            height: 24px !important;
            min-width: 80px !important;
            padding: 0 8px 0 24px !important; /* Space for icon */
            
            background-color: transparent !important;
            border: 1px solid transparent !important;
            border-radius: 4px !important;
            
            color: #9ca3af !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .problem-settings-btn:hover,
        .dropdown-container.open .problem-settings-btn {
            background-color: #3e4451 !important;
            color: #fff !important;
        }

        .problem-settings-btn svg {
            position: absolute;
            left: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            transition: color 0.3s;
        }
        
        .problem-settings-btn .gear-green { color: #4ade80 !important; }
        .problem-settings-btn .gear-red { color: #ef4444 !important; }
        
        @keyframes electric-slide { 0% { transform: translateX(-100%); opacity: 0.5; } 50% { opacity: 1; } 100% { transform: translateX(300%); opacity: 0.5; } }
        .animate-loading-bar { width: 40%; height: 100%; background: linear-gradient(90deg, transparent, #eab308, #fbbf24, transparent); animation: electric-slide 1.2s infinite ease-in-out; filter: blur(1px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.3s var(--ease-spring) forwards; }
        
        /* New Animation for Project Switching */
        .animate-quick-fade { animation: quickFade 0.25s var(--ease-spring) forwards; }
        @keyframes quickFade { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

        .action-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .action-btn:active { transform: scale(0.96); }

        #problem-container { transition: width 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); overflow: hidden; width: 25%; } /* Default open width */
        
        #problem-content { 
            font-size: var(--problem-font-size); 
            line-height: 1.6; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            outline: none; 
            overflow-y: auto; 
            height: 100%; 
            position: relative; /* For absolute placeholder */
        }
        
        /* FORCE INHERITANCE: Ensure pasted content respects container's font size settings */
        #problem-content * {
            background-color: transparent !important;
            color: inherit !important;
            box-shadow: none !important;
            font-family: inherit !important;
            font-size: inherit !important;   /* Crucial for zoom feature */
            line-height: inherit !important;
        }
        
        /* Restore semantic styles with !important to override reset */
        #problem-content b, #problem-content strong { font-weight: bold !important; }
        #problem-content i, #problem-content em { font-style: italic !important; }
        #problem-content u { text-decoration: underline !important; }
        
        /* Placeholder logic using CSS class .empty */
        #problem-content.empty::before {
            content: "Enter problem description here...";
            color: #666;
            font-style: italic;
            pointer-events: none;
            display: block;
            position: absolute;
            top: 1rem;
            left: 1rem;
        }

        /* Problem List Styles */
        #problem-list { overflow-y: auto; height: 100%; }
        .problem-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .problem-item:hover { background-color: #2d2d2d; }
        .problem-item.active { background-color: #37373d; border-left: 3px solid #007acc; }
        .problem-item-title { font-size: 13px; color: #ccc; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
        .problem-item.active .problem-item-title { color: #fff; }
        .problem-item-actions { display: none; gap: 4px; }
        .problem-item:hover .problem-item-actions { display: flex; }
        /* Always show pin for main */
        .problem-item.is-main .problem-item-actions { display: flex; }
        .problem-action-btn { padding: 2px; border-radius: 3px; color: #858585; display: flex; align-items: center; justify-content: center; }
        .problem-action-btn:hover { background-color: #454545; color: #fff; }
        .problem-action-btn.pin { color: #eab308; cursor: default; }
        .problem-action-btn.pin:hover { background-color: transparent; }

        /* View Transition Animation */
        .side-view-content { animation: fadeIn 0.3s var(--ease-spring); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        #modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(2px); z-index: 9999; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        #modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box { background: #252526; border: 1px solid #454545; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); width: 90%; max-width: 400px; transform: scale(0.95); transition: transform 0.2s; overflow: hidden; display: flex; flex-direction: column; }
        #modal-overlay.open .modal-box { transform: scale(1); }
        .modal-header { padding: 12px 16px; background: #2d2d2d; border-bottom: 1px solid #333; font-weight: bold; color: #fff; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px 16px; color: #d4d4d4; font-size: 14px; line-height: 1.5; display: flex; flex-direction: column; gap: 10px; }
        .modal-footer { padding: 12px 16px; background: #252526; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 8px; }
        .modal-btn { padding: 6px 14px; border-radius: 4px; font-size: 13px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
        .modal-btn-primary { background: #007acc; color: white; border-color: #007acc; }
        .modal-btn-primary:hover { background: #0062a3; }
        .modal-btn-danger { background: #e04f5f; color: white; border-color: #e04f5f; }
        .modal-btn-danger:hover { background: #c03645; }
        .modal-btn-secondary { background: #3c3c3c; color: #ccc; border-color: #555; }
        .modal-btn-secondary:hover { background: #454545; color: white; }
        
        .modal-input {
            background-color: #3c3c3c;
            border: 1px solid #555;
            color: white;
            padding: 8px;
            border-radius: 4px;
            outline: none;
            width: 100%;
        }
        .modal-input:focus {
            border-color: #007acc;
        }

        /* Unified Button Animation */
        #problem-toggle-btn {
            transition: all 0.2s var(--ease-spring);
        }
        #problem-toggle-btn:active {
            transform: scale(0.95);
        }
        /* Active State Style */
        #problem-toggle-btn.text-blue-400 {
            background-color: rgba(59, 130, 246, 0.1); /* Light blue bg */
        }

        /* Problem Button Container Styles */
        .problem-btn-container {
            border-right: 1px solid var(--border-color);
            display: flex;
            align-items: center; 
            justify-content: center;
            background-color: #252526;
            padding: 0 4px; /* Added padding */
            height: 32px; /* Match tab height */
        }

        .problem-btn-container button {
            height: 24px;
            width: 24px;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af; 
            transition: all 0.2s var(--ease-spring);
        }

        .problem-btn-container button:hover {
            background-color: #3e4451; 
            color: #fff;
            transform: translateY(-1px);
        }
        
        .problem-btn-container button:active {
            transform: scale(0.95);
        }
        .problem-btn-container button.text-blue-400 {
            color: #60a5fa; 
            background-color: rgba(59, 130, 246, 0.15);
        }
        

        @media (max-width: 1024px) {
            .action-btn span { display: none; }
            .action-btn svg { margin: 0; }
            .action-btn { padding: 6px 10px; }
            #problem-container { position: absolute; left: 0; top: 0; bottom: 0; width: 0; z-index: 50; border-right: none; box-shadow: none; background-color: var(--bg-color); }
            #problem-container.problem-open { width: 75% !important; border-right: 1px solid var(--border-color); box-shadow: 4px 0 20px rgba(0,0,0,0.5); }
            #problem-resizer { display: none !important; } 
        }
        @media (max-width: 768px) {
            header { padding: 0 8px; }
            .dropdown-trigger { padding: 4px 6px; min-width: auto; }
            #logo-icon { width: 1.5rem; height: 1.5rem; font-size: 0.7rem; }
        }
    </style>
</head>
<body class="flex flex-col select-none overflow-hidden fixed inset-0 w-full h-full" data-theme="classic">

    <!-- Hidden File Input -->
    <input type="file" id="file-input" style="display: none;">

    <header class="h-14 border-b border-[#333] flex items-center justify-between px-4 bg-[#252526] flex-none z-50 transition-colors duration-300">
        <!-- Left Side -->
        <div class="flex items-center gap-3">
            <div class="w-7 h-7 rounded bg-blue-600 flex items-center justify-center text-white font-bold text-sm shadow-md transition-all duration-300" id="logo-icon">C++</div>
            
            <div class="dropdown-container" id="lang-dropdown">
                <div class="dropdown-trigger" onclick="toggleDropdown('lang-dropdown')">
                    <span id="lang-display">C++ Galaxy</span>
                    <svg class="w-3 h-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
                <div class="dropdown-menu">
                    <div class="dropdown-item selected" onclick="selectLanguage('cpp')" data-value="cpp">C++ Galaxy</div>
                    <div class="dropdown-item" onclick="selectLanguage('python')" data-value="python">Python 3</div>
                </div>
            </div>

            <div class="flex items-center gap-2 ml-2 bg-[#1e1e1e] px-2 py-1 rounded text-xs border border-[#333] transition-all duration-300" title="Server Status">
                <div id="status-indicator" class="status-dot status-disconnected"></div>
                <span id="status-text" class="text-gray-500 transition-colors duration-300">Disconnected</span>
            </div>
            <span class="text-xs text-gray-600 ml-1 font-mono select-none">v5.6.4</span>
        </div>
        
        <!-- Right Side -->
        <div class="flex items-center gap-3">
            
            <!-- Settings Dropdown -->
            <div class="dropdown-container" id="settings-dropdown">
                <div class="settings-btn dropdown-trigger" onclick="toggleDropdown('settings-dropdown')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="w-full text-center">Settings</span>
                </div>
                <div class="dropdown-menu" style="right: 0; left: auto; min-width: 160px; transform-origin: top right;">
                    <div class="dropdown-label">View</div>
                    <div class="dropdown-item" id="layout-opt-right" onclick="selectLayout('right')">
                        <span>Output: Right</span>
                        <svg class="h-4 w-4 text-blue-400 opacity-0 check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <div class="dropdown-item" id="layout-opt-bottom" onclick="selectLayout('bottom')">
                        <span>Output: Bottom</span>
                        <svg class="h-4 w-4 text-blue-400 opacity-0 check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    
                    <div class="my-1 border-t border-[#454545]"></div>
                    
                    <div class="dropdown-label">Theme</div>
                    <div class="dropdown-item" id="theme-opt-modern" onclick="setTheme('modern')">
                        <span>Modern</span>
                        <svg class="h-4 w-4 text-blue-400 opacity-0 check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <div class="dropdown-item" id="theme-opt-classic" onclick="setTheme('classic')">
                        <span>Classic</span>
                        <svg class="h-4 w-4 text-blue-400 opacity-0 check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </div>

                    <div class="my-1 border-t border-[#454545]"></div>
                    
                    <div class="dropdown-label">File</div>
                    <div class="dropdown-item" onclick="openFileConfirm()">
                        <span>Open File</span>
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" /></svg>
                    </div>
                    <div class="dropdown-item" onclick="downloadCode()">
                        <span>Download</span>
                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </div>
                </div>
            </div>

            <button onclick="stopCode()" class="action-btn flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-3 py-1.5 rounded text-sm transition-colors hidden" id="stop-btn" title="Stop Code"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg><span>Stop</span></button>
            <button onclick="runCode()" class="action-btn flex items-center gap-2 bg-[#2ea043] hover:bg-[#238636] text-white px-4 py-1.5 rounded text-sm font-medium transition-colors shadow-lg active:scale-95" id="run-btn" title="Run Code"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg><span>Run</span></button>
        </div>
    </header>

    <main id="main-container" class="flex-1 flex flex-row overflow-hidden relative bg-[#1e1e1e] min-h-0">
        
        <!-- 左側：題目面板 (獨立列 - 改造為側邊清單/內容區) -->
        <div id="problem-container" class="flex flex-col bg-[#1e1e1e] border-r border-[#333] min-w-0 ease-out problem-open">
            <div class="flex items-center px-3 py-1 bg-[#252526] border-b border-[#333] flex-none h-8 gap-2">
                <div class="flex items-center gap-1">
                    <!-- 改進後的切換開關 (Sliding Toggle) - 使用統一風格, 點擊容器切換 -->
                    <div class="side-panel-toggle toggle-container-base" id="side-panel-toggle-container" onclick="toggleSidePanel()">
                        <div class="side-toggle-bg toggle-bg-base"></div>
                        <div class="side-toggle-btn active toggle-option-base" id="side-toggle-list">List</div>
                        <div class="side-toggle-btn toggle-option-base" id="side-toggle-desc">Desc</div>
                    </div>
                </div>
                
                <!-- 題目面板工具列 - 列表模式 -->
                <div id="list-toolbar" class="flex items-center gap-1 ml-auto">
                    <button onclick="resetPanelWidth()" class="toolbar-btn text-gray-400" title="Reset Panel Width"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg></button>
                    <button onclick="requestNewProjectName()" class="toolbar-btn text-gray-400" title="New Project"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                </div>

                <!-- 題目面板工具列 - 說明模式 (預設隱藏) -->
                <div id="desc-toolbar" class="hidden items-center gap-1 ml-auto">
                    <button onclick="changeProblemFontSize(-1)" class="toolbar-btn text-gray-400" title="Decrease Font"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg></button>
                    <button onclick="resetProblemFontSize()" class="toolbar-btn text-gray-400" title="Reset Font"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg></button>
                    <button onclick="changeProblemFontSize(1)" class="toolbar-btn text-gray-400" title="Increase Font"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                    <div class="toolbar-separator"></div>
                    <button onclick="pasteToProblem()" class="toolbar-btn text-gray-400 hover:text-blue-400" title="Paste All"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg></button>
                </div>
                
                <!-- 新增：關閉按鈕 (在移動端或任何模式下都可見) -->
                <button onclick="toggleProblemPanel()" class="toolbar-btn text-gray-400 hover:text-red-400 ml-1" title="Close Panel"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>

            <!-- 內容區域 1: 專案列表 (加入淡入動畫) -->
            <div id="problem-list" class="flex-1 bg-[#1e1e1e] w-full h-full side-view-content">
                <!-- 由 JS 動態生成 -->
            </div>

            <!-- 內容區域 2: 題目說明 (預設隱藏，加入淡入動畫) -->
            <div id="problem-content" contenteditable="true" class="hidden flex-1 bg-[#1e1e1e] text-gray-300 p-4 w-full h-full font-mono text-sm side-view-content"></div>
        </div>

        <!-- 分隔線 1：控制題目欄寬度 -->
        <div id="problem-resizer" class="resizer-split resizer-col" title="Drag to resize"></div>

        <!-- 中間區域 Wrapper (包含編輯器+終端機) -->
        <div id="center-area" class="flex-1 flex flex-row min-w-0 min-h-0">
            
            <!-- 編輯器區域 -->
            <div id="editor-container" class="flex-col relative min-h-0 min-w-0 flex" style="flex: 0 0 70%;">
                
                <!-- 新的 Toolbar (無 Tab) -->
                <div class="bg-[#252526] px-2 py-1 text-xs font-mono text-gray-500 flex justify-between items-center select-none flex-none border-b border-[#333] h-8 transition-colors duration-300">
                     <div class="flex items-center">
                        <div class="problem-btn-container mr-2 border-r border-[#333]">
                            <button onclick="toggleProblemPanel()" id="problem-toggle-btn" class="text-blue-400 bg-blue-500/10" title="Toggle Problem Panel">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- NEW: Problem Settings Dropdown Moved Here -->
                        <div class="dropdown-container mr-2" id="problem-settings-dropdown">
                            <div class="problem-settings-btn dropdown-trigger" onclick="toggleDropdown('problem-settings-dropdown')" title="Project Settings">
                                <svg class="w-3.5 h-3.5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span>For Test</span>
                            </div>
                            <div class="dropdown-menu" style="left: 0; right: auto; min-width: 180px;">
                                <div class="dropdown-item" id="enable-test-mode-opt" onclick="toggleTestMode()">
                                    <span>Enable Test Mode</span>
                                    <svg class="h-4 w-4 text-blue-400 opacity-0 check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                </div>
                                <div class="my-1 border-t border-[#454545]"></div>
                                 <div class="dropdown-item" onclick="saveDefaultCode()">
                                    <span>Save Current as Template</span>
                                </div>
                                <div class="dropdown-item disabled" id="reset-template-opt" onclick="resetToTemplate()">
                                    <span>Reset to Template</span>
                                </div>
                                <div class="dropdown-item disabled" id="use-default-code-opt" onclick="toggleUseDefaultCode()">
                                    <span>Reset on Reload</span>
                                    <svg class="h-4 w-4 text-blue-400 opacity-0 check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                </div>
                            </div>
                        </div>

                        <span class="font-bold text-gray-300" id="current-project-title">main</span>
                     </div>
                    
                    <div class="flex items-center gap-1">
                        <button onclick="changeFontSize(-1)" class="toolbar-btn text-gray-400" title="Decrease Font"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" /></svg></button>
                        <button onclick="resetFontSize()" class="toolbar-btn text-gray-400" title="Reset Font"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg></button>
                        <button onclick="changeFontSize(1)" class="toolbar-btn text-gray-400" title="Increase Font"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg></button>
                        <div class="toolbar-separator"></div>
                        <button onclick="undoCode()" class="toolbar-btn text-gray-400" title="Undo"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" /></svg></button>
                        <button onclick="redoCode()" class="toolbar-btn text-gray-400" title="Redo"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" /></svg></button>
                        <button id="copy-btn" onclick="copyCode()" class="toolbar-btn text-gray-400" title="Select All & Copy"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                        <button id="format-btn" onclick="formatCode()" class="toolbar-btn text-gray-400 hover:text-purple-400" title="Format Code"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button>
                        <button id="toggle-comment-btn" onclick="toggleComments()" class="toolbar-btn text-gray-400 hover:text-yellow-400" title="Toggle Comments"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg></button>
                        <button onclick="clearAllCode()" class="toolbar-btn text-gray-400 hover:text-red-400" title="Clear All"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        <button onclick="insertHelloWorld()" class="toolbar-btn text-gray-400 hover:text-yellow-300" title="Insert Hello World"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg></button>
                        <button onclick="clearAndPaste()" class="toolbar-btn text-gray-400 hover:text-blue-400" title="Clear & Paste"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg></button>
                    </div>
                </div>
                <div class="flex-1 overflow-hidden relative w-full h-full min-h-0">
                    <div id="code-wrapper" class="w-full h-full relative animate-quick-fade">
                        <textarea id="code-editor">#include <iostream>
using namespace std;

int main() {
    cout << "Hello World" << endl;
    return 0;
}</textarea>
                    </div>
                </div>
            </div>
            
            <div id="terminal-resizer" class="resizer-split resizer-col" title="Drag to resize"></div>
            
            <div id="output-container-wrapper" class="flex-col bg-[#1e1e1e] min-h-0 min-w-0 transition-all duration-100 ease-out flex" style="flex: 0 0 30%;">
                <div class="bg-[#1e1e1e] px-4 py-1 text-xs font-bold text-gray-500 border-b border-[#333] flex justify-between flex-none h-8 items-center">
                    <span>Interactive Terminal</span>
                    <button onclick="clearOutput()" class="hover:text-white transition-colors duration-200">Clear</button>
                </div>
                
                <div class="p-2 border-b border-[#333] bg-[#252526] flex-none flex flex-col gap-2">
                    <textarea id="terminal-input" class="w-full bg-[#3c3c3c] text-white px-3 py-2 rounded border border-[#555] focus:outline-none focus:border-[#007acc] focus:ring-1 focus:ring-[#007acc] font-mono text-sm resize-none h-16" placeholder="Type input here (Enter for new line, Ctrl+Enter to send)..." disabled autocomplete="off"></textarea>
                    <div class="flex justify-end gap-2">
                        <!-- New 'Last Input' Button -->
                        <button onclick="fillLastInput()" class="bg-[#4b5563] hover:bg-[#374151] text-white px-3 py-1.5 rounded text-xs font-medium transition-colors shadow-md flex items-center gap-1" title="Fill Last Input">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span>Last Input</span>
                        </button>
                        <button id="send-input-btn" onclick="sendInput()" class="bg-[#2ea043] hover:bg-[#238636] text-white px-4 py-1.5 rounded text-xs font-medium transition-colors shadow-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>Send Input</button>
                    </div>
                </div>

                <div id="terminal-container" class="flex-1 p-4 font-mono text-sm overflow-auto text-gray-300 relative min-h-0" onclick="focusInput()">
                    <pre id="output" class="whitespace-pre-wrap break-words block font-[Consolas,Monaco,monospace]"></pre><span class="terminal-cursor"></span>
                </div>
            </div>
        </div>
    </main>

    <!-- Custom Modal Overlay -->
    <div id="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span id="modal-title">Title</span>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div class="modal-body">
                <div id="modal-message">Message</div>
                <input type="text" id="modal-input" class="modal-input hidden" autocomplete="off" placeholder="Enter text...">
            </div>
            <div class="modal-footer" id="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/match-highlighter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/format/formatting.min.js"></script>

    <script>
        var socket;
        try {
            socket = io();
        } catch (e) {
            console.error("Socket.io fail to load", e);
        }

        var isRunning = false;
        var statusDot = document.getElementById('status-indicator');
        var statusText = document.getElementById('status-text');
        var currentLayout = 'right';
        var fontSize = 14;
        var problemFontSize = 14; 
        var currentLang = 'cpp'; 
        
        // --- Project System State ---
        var projects = [];
        var activeProjectIndex = 0;
        var currentSideView = 'list'; // 'list' or 'desc'
        var currentTheme = 'classic'; // Default theme
        var lastInput = ""; // Store last input

        // Modal System
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalFooter = document.getElementById('modal-footer');
        
        function showModal(title, message) {
            modalTitle.innerText = title;
            modalMessage.innerHTML = message.replace(/\n/g, '<br>');
            modalInput.classList.add('hidden');
            modalFooter.innerHTML = '<button class="modal-btn modal-btn-primary" onclick="closeModal()">OK</button>';
            modalOverlay.classList.add('open');
        }
        
        function showConfirm(title, message, onConfirm) {
            modalTitle.innerText = title;
            modalMessage.innerHTML = message.replace(/\n/g, '<br>');
            modalInput.classList.add('hidden');
            modalFooter.innerHTML = '';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn modal-btn-secondary';
            cancelBtn.innerText = 'Cancel';
            cancelBtn.onclick = closeModal;
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn modal-btn-danger';
            confirmBtn.innerText = 'Confirm';
            confirmBtn.onclick = function() {
                closeModal();
                onConfirm();
            };
            
            modalFooter.appendChild(cancelBtn);
            modalFooter.appendChild(confirmBtn);
            modalOverlay.classList.add('open');
        }

        function showInputModal(title, message, placeholder, defaultValue, onConfirm) {
            modalTitle.innerText = title;
            modalMessage.innerHTML = message.replace(/\n/g, '<br>');
            modalInput.classList.remove('hidden');
            modalInput.placeholder = placeholder || '';
            modalInput.value = defaultValue || '';
            
            modalFooter.innerHTML = '';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'modal-btn modal-btn-secondary';
            cancelBtn.innerText = 'Cancel';
            cancelBtn.onclick = closeModal;
            
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'modal-btn modal-btn-primary';
            confirmBtn.innerText = 'Confirm';
            confirmBtn.onclick = function() {
                const val = modalInput.value.trim();
                if(val) {
                    closeModal();
                    onConfirm(val);
                } else {
                    // Slight shake or visual cue could act here
                    modalInput.focus();
                }
            };
            
            modalFooter.appendChild(cancelBtn);
            modalFooter.appendChild(confirmBtn);
            modalOverlay.classList.add('open');
            setTimeout(() => modalInput.focus(), 100);
        }
        
        // Allow Enter key in modal input
        modalInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const btn = modalFooter.querySelector('.modal-btn-primary');
                if(btn) btn.click();
            }
        });
        
        function closeModal() {
            modalOverlay.classList.remove('open');
        }

        // --- File Open Logic ---
        function openFileConfirm() {
            showConfirm("Open File", "Opening a file will overwrite current code.\nAre you sure you want to continue?", triggerFileSelect);
        }

        function triggerFileSelect() {
            const fileInput = document.getElementById('file-input');
            if (currentLang === 'cpp') {
                fileInput.accept = '.cpp';
            } else {
                fileInput.accept = '.py';
            }
            fileInput.click();
        }

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const filename = file.name.toLowerCase();
            if (currentLang === 'cpp' && !filename.endsWith('.cpp')) {
                showModal("File Error", "Please select a valid C++ file (.cpp)");
                this.value = '';
                return;
            }
            if (currentLang === 'python' && !filename.endsWith('.py')) {
                showModal("File Error", "Please select a valid Python file (.py)");
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                editor.setValue(e.target.result);
                saveCurrentProject(); // Auto save after load
            };
            reader.readAsText(file);
            this.value = '';
        });

        // CodeMirror Setup
        var cppKeywords = ["#include","iostream","cstdlib","iomanip","using","namespace","std","int","main","return","cout","endl","cin","vector","string","void","char","bool","float","double","if","else","for","while","do","switch","case","break","continue","struct","class","public","private","protected","true","false","const","auto","size_t","push_back","pop_back","length","size","begin","end","algorithm","cmath"];
        var pythonKeywords = ["print","import","from","def","return","if","elif","else","for","while","break","continue","pass","class","try","except","finally","with","as","lambda","True","False","None","and","or","not","is","in","global","range","len","input","int","str","list","dict"];

        function codeHint(editor) {
            var cur = editor.getCursor();
            var token = editor.getTokenAt(cur);
            var word = token.string;
            var start = token.start;
            var end = cur.ch;
            if (token.end > cur.ch) word = word.slice(0, cur.ch - token.start);
            if (!/^[\w#]+$/.test(word)) {
                var line = editor.getLine(cur.line);
                var i = cur.ch - 1;
                while (i >= 0 && /[\w#]/.test(line.charAt(i))) i--;
                start = i + 1;
                word = line.slice(start, cur.ch);
            }
            if (!word) return;
            var keywords = currentLang === 'cpp' ? cppKeywords : pythonKeywords;
            var list = keywords.filter(function(item) { return item.startsWith(word); });
            return { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
        }

        var editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: "text/x-c++src", theme: "cloudjudge", lineNumbers: true, matchBrackets: true, autoCloseBrackets: true, indentUnit: 4, tabSize: 4, lineWrapping: true,
            highlightSelectionMatches: { showToken: /\w/, annotateScrollbar: true },
            extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Enter": function(cm) {
                    if (cm.getOption("disableInput")) return CodeMirror.Pass;
                    var cursor = cm.getCursor(); var line = cm.getLine(cursor.line);
                    if (line.charAt(cursor.ch - 1) === '{' && line.charAt(cursor.ch) === '}') {
                        cm.execCommand("newlineAndIndent"); cm.replaceSelection("\n", "start"); var newCursor = cm.getCursor();
                        cm.indentLine(newCursor.line, null, true); cm.indentLine(newCursor.line + 1, null, true);
                        cm.setCursor(newCursor.line, cm.getLine(newCursor.line).length); return;
                    } 
                    if (currentLang === 'python' && line.trim().endsWith(':')) { cm.execCommand("newlineAndIndent"); return; }
                    return CodeMirror.Pass; 
                },
                "Backspace": function(cm) {
                    if (cm.somethingSelected()) return CodeMirror.Pass;
                    var cursor = cm.getCursor();
                    var line = cm.getLine(cursor.line);
                    var beforeCursor = line.slice(0, cursor.ch);
                    if (/^\s+$/.test(beforeCursor)) {
                        var indentUnit = cm.getOption("indentUnit");
                        var spacesToDelete = beforeCursor.length % indentUnit || indentUnit;
                        if (beforeCursor.length >= spacesToDelete) {
                            var from = {line: cursor.line, ch: cursor.ch - spacesToDelete};
                            var to = {line: cursor.line, ch: cursor.ch};
                            cm.replaceRange("", from, to);
                            return;
                        }
                    }
                    return CodeMirror.Pass; 
                }
            }
        });
        
        function formatCode() {
            var totalLines = editor.lineCount();
            var cursor = editor.getCursor();
            editor.setSelection({line: 0, ch: 0}, {line: totalLines, ch: 0});
            editor.indentSelection("smart");
            editor.setCursor(cursor);
        }

        editor.addOverlay({
            token: function(stream) {
                if (currentLang !== 'cpp') { stream.skipToEnd(); return null; }
                if (stream.eatWhile(/[^a-zA-Z_]/)) return null;
                if (stream.match(/\b(string)\b/)) { return "string-type"; }
                if (stream.match(/\b(std|cin|cout|endl|vector|map|set|queue|stack|deque|list|pair|iomanip)\b/)) { return "builtin"; }
                stream.eatWhile(/[a-zA-Z0-9_]/); 
                return null;
            }
        });

        // --- Layout & Sidebar Logic ---
        const problemContainer = document.getElementById('problem-container');
        const problemResizer = document.getElementById('problem-resizer');
        const centerArea = document.getElementById('center-area');
        const problemListEl = document.getElementById('problem-list');
        const problemContentEl = document.getElementById('problem-content');
        const problemToggleBtn = document.getElementById('problem-toggle-btn');
        const editorContainer = document.getElementById('editor-container');
        const listToolbar = document.getElementById('list-toolbar');
        const descToolbar = document.getElementById('desc-toolbar');
        const toggleListBtn = document.getElementById('side-toggle-list');
        const toggleDescBtn = document.getElementById('side-toggle-desc');
        const toggleContainer = document.getElementById('side-panel-toggle-container');
        
        function toggleProblemPanel() {
            if (problemContainer.classList.contains('problem-open')) {
                // Close it
                problemContainer.classList.remove('problem-open');
                problemContainer.style.width = '0px';
                if(window.innerWidth > 1024) problemResizer.classList.add('hidden');
                problemToggleBtn.classList.remove('text-blue-400', 'bg-blue-500/10');
                editor.focus();
            } else {
                // Open it
                problemContainer.classList.add('problem-open');
                if(window.innerWidth > 1024) {
                    problemContainer.style.width = '25%';
                    problemResizer.classList.remove('hidden');
                }
                problemToggleBtn.classList.add('text-blue-400', 'bg-blue-500/10');
            }
            setTimeout(() => editor.refresh(), 350);
        }

        function resetPanelWidth() {
            if(window.innerWidth > 1024) {
                problemContainer.style.width = '25%';
                // Ensure it's open
                if (!problemContainer.classList.contains('problem-open')) {
                    toggleProblemPanel();
                }
                editor.refresh();
            }
        }

        // --- Side Panel View Switching ---
        function toggleSidePanel() {
            const newView = currentSideView === 'list' ? 'desc' : 'list';
            toggleSideView(newView);
        }

        function toggleSideView(view) {
            currentSideView = view;
            
            // Re-trigger animation for content fade
            problemListEl.classList.remove('side-view-content');
            problemContentEl.classList.remove('side-view-content');
            void problemListEl.offsetWidth; // Trigger reflow
            void problemContentEl.offsetWidth;
            
            if (view === 'list') {
                problemListEl.classList.remove('hidden');
                problemListEl.classList.add('side-view-content');
                problemContentEl.classList.add('hidden');
                
                listToolbar.style.display = 'flex';
                descToolbar.style.display = 'none';
                
                toggleListBtn.classList.add('active');
                toggleDescBtn.classList.remove('active');
                toggleContainer.classList.remove('show-desc'); // Sliding animation handled by CSS
            } else {
                problemListEl.classList.add('hidden');
                problemContentEl.classList.remove('hidden');
                problemContentEl.classList.add('side-view-content');
                
                listToolbar.style.display = 'none';
                descToolbar.style.display = 'flex';
                
                toggleListBtn.classList.remove('active');
                toggleDescBtn.classList.add('active');
                toggleContainer.classList.add('show-desc'); // Sliding animation handled by CSS
            }
            
            // Update placeholder logic on view switch
            updateProblemContentPlaceholder();
        }

        // --- Project / Problem Data Management ---
        function getHelloWorld(lang) {
            if (lang === 'cpp') return '#include <iostream>\nusing namespace std;\n\nint main() {\n    cout << "Hello World" << endl;\n    return 0;\n}';
            else return 'print("Hello Galaxy Python!")\n\n# Try typing something\nname = input("Please enter your name: ")\nprint(f"Nice to meet you, {name}!")';
        }

        // Initialize projects from localStorage or default
        function initProjects() {
            try {
                const savedProjects = localStorage.getItem(`galaxy_projects_${currentLang}`);
                
                if (savedProjects) {
                    projects = JSON.parse(savedProjects);
                    
                    // Reset Logic: If useDefaultCode is true, reset code to defaultCode
                    projects.forEach(p => {
                        // FIX: Only reset if testMode is TRUE (Safe Mode)
                        if (p.testMode && p.useDefaultCode && p.defaultCode) {
                            p.code = p.defaultCode;
                        }
                    });
                    
                    const mainIndex = projects.findIndex(p => p.id === 'main');
                    if (mainIndex === -1) {
                        projects.unshift({ id: 'main', title: 'main', code: getHelloWorld(currentLang), desc: '' });
                    } else if (mainIndex > 0) {
                        const mainProject = projects.splice(mainIndex, 1)[0];
                        projects.unshift(mainProject);
                    }
                    projects[0].title = 'main';
                    
                } else {
                    projects = [{ id: 'main', title: 'main', code: getHelloWorld(currentLang), desc: '' }];
                }
                
                const savedIndex = parseInt(localStorage.getItem(`galaxy_active_project_${currentLang}`) || "0");
                activeProjectIndex = (savedIndex >= 0 && savedIndex < projects.length) ? savedIndex : 0;

            } catch (e) {
                console.error("Init projects error", e);
                projects = [{ id: 'main', title: 'main', code: getHelloWorld(currentLang), desc: '' }];
                activeProjectIndex = 0;
            }
            
            renderProjectList();
            loadProject(activeProjectIndex);
        }

        function saveProjectsToStorage() {
            localStorage.setItem(`galaxy_projects_${currentLang}`, JSON.stringify(projects));
        }

        function saveCurrentProject() {
            if (projects[activeProjectIndex]) {
                projects[activeProjectIndex].code = editor.getValue();
                projects[activeProjectIndex].desc = problemContentEl.innerHTML;
                saveProjectsToStorage();
            }
        }

        function requestNewProjectName() {
            if (projects.length >= 21) { // 20 custom + 1 main
                showModal("Notice", "Project limit reached (20).");
                return;
            }
            
            let counter = 1;
            // Find the first available number
            while (projects.some(p => p.title.toLowerCase() === `program ${counter}`)) {
                counter++;
            }
            const defaultName = `program ${counter}`;

            showInputModal("New Project", "Please enter project name:", "e.g., program 1", defaultName, (name) => {
                // Prevent empty name, fallback to default if user cleared it
                addProject(name || defaultName);
            });
        }

        function addProject(title) {
            const newId = Date.now();
            const newProject = {
                id: newId,
                title: title,
                code: getHelloWorld(currentLang),
                desc: "",
                testMode: false // Default to Unsafe (Red)
            };
            projects.push(newProject);
            saveProjectsToStorage();
            renderProjectList();
            selectProject(projects.length - 1);
        }
        
        function renameProject(index, event) {
            if (event) event.stopPropagation();
            
            const project = projects[index];
            if (project.id === 'main') {
                showModal("Notice", "The 'main' project cannot be renamed.");
                return;
            }
            
            showInputModal("Rename", `Enter new name:`, "", project.title, (newName) => {
                project.title = newName;
                saveProjectsToStorage();
                renderProjectList();
                if (index === activeProjectIndex) {
                    document.getElementById('current-project-title').innerText = newName;
                }
            });
        }

        function deleteProject(index, event) {
            if (event) event.stopPropagation();
            
            if (projects[index].id === 'main') {
                showModal("Notice", "The 'main' project cannot be deleted.");
                return;
            }

            showConfirm("Delete Project", `Are you sure you want to delete "${projects[index].title}"? This action cannot be undone.`, () => {
                projects.splice(index, 1);
                
                if (index === activeProjectIndex) {
                    activeProjectIndex = Math.max(0, index - 1);
                } else if (index < activeProjectIndex) {
                    activeProjectIndex--;
                }
                
                saveProjectsToStorage();
                renderProjectList();
                loadProject(activeProjectIndex);
            });
        }

        function selectProject(index) {
            if (index === activeProjectIndex) {
                toggleSideView('desc');
                return;
            }
            
            saveCurrentProject();
            
            activeProjectIndex = index;
            localStorage.setItem(`galaxy_active_project_${currentLang}`, activeProjectIndex);
            
            // Trigger animation on editor & content before loading new data
            triggerProjectSwitchAnimation();
            
            loadProject(index);
            renderProjectList();
        }
        
        function triggerProjectSwitchAnimation() {
            const codeWrapper = document.getElementById('code-wrapper');
            const problemContent = document.getElementById('problem-content');
            
            // Reset Animation
            codeWrapper.classList.remove('animate-quick-fade');
            problemContent.classList.remove('animate-quick-fade');
            
            // Trigger Reflow
            void codeWrapper.offsetWidth;
            
            // Re-apply Animation
            codeWrapper.classList.add('animate-quick-fade');
            problemContent.classList.add('animate-quick-fade');
        }

        function loadProject(index) {
            const project = projects[index];
            if (!project) return;
            
            isChangingProject = true;
            
            editor.setValue(project.code);
            problemContentEl.innerHTML = project.desc || ""; 
            document.getElementById('current-project-title').innerText = project.title;
            
            // Update Problem Settings Dropdown UI based on current project state
            updateProblemSettingsUI();
            
            // Update placeholder state
            updateProblemContentPlaceholder();
            
            isChangingProject = false;
        }

        function renderProjectList() {
            problemListEl.innerHTML = '';
            projects.forEach((proj, idx) => {
                const item = document.createElement('div');
                const isMain = proj.id === 'main';
                item.className = `problem-item ${idx === activeProjectIndex ? 'active' : ''} ${isMain ? 'is-main' : ''}`;
                item.onclick = () => selectProject(idx);
                
                const title = document.createElement('div');
                title.className = 'problem-item-title';
                title.innerText = proj.title;
                
                const actions = document.createElement('div');
                actions.className = 'problem-item-actions';
                
                if (isMain) {
                    const pinIcon = document.createElement('div');
                    pinIcon.className = 'problem-action-btn pin';
                    pinIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="currentColor"><path d="M16 12V6a4 4 0 0 0-8 0v6l-2 2v2h5v6h2v-6h5v-2l-2-2z"/></svg>`;
                    pinIcon.title = "Pinned Project";
                    actions.appendChild(pinIcon);
                } else {
                    const renameBtn = document.createElement('div');
                    renameBtn.className = 'problem-action-btn';
                    renameBtn.title = "Rename";
                    renameBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>';
                    renameBtn.onclick = (e) => renameProject(idx, e);
                    
                    const delBtn = document.createElement('div');
                    delBtn.className = 'problem-action-btn';
                    delBtn.title = "Delete";
                    delBtn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>';
                    delBtn.onclick = (e) => deleteProject(idx, e);
                    
                    actions.appendChild(renameBtn);
                    actions.appendChild(delBtn);
                }
                
                item.appendChild(title);
                item.appendChild(actions);
                problemListEl.appendChild(item);
            });
        }
        
        var isChangingProject = false;
        
        editor.on("change", function() {
            if (!isChangingProject && !isChangingLang) {
                projects[activeProjectIndex].code = editor.getValue();
                saveProjectsToStorage();
            }
        });
        
        // Placeholder Logic Helper
        function updateProblemContentPlaceholder() {
            // Check if text content is empty (ignoring HTML tags like <br> or empty <p>)
            // Using innerText check
            if (problemContentEl.innerText.trim() === "") {
                problemContentEl.classList.add('empty');
            } else {
                problemContentEl.classList.remove('empty');
            }
        }
        
        problemContentEl.addEventListener('input', function() {
            // Toggle placeholder class immediately
            updateProblemContentPlaceholder();
            
            if (!isChangingProject) {
                // If content is visually empty, save empty string
                if(this.innerText.trim() === "") {
                     projects[activeProjectIndex].desc = "";
                } else {
                     projects[activeProjectIndex].desc = this.innerHTML;
                }
                saveProjectsToStorage();
            }
        });

        // --- HTML Sanitization for Paste (Smart Paste) ---
        function cleanHTML(html) {
            const div = document.createElement('div');
            div.innerHTML = html;
            div.querySelectorAll('*').forEach(el => {
                const s = el.style;
                // Detect styles before stripping
                const isBold = (s.fontWeight === 'bold' || parseInt(s.fontWeight) >= 700) || ['B', 'STRONG'].includes(el.tagName);
                const isItalic = (s.fontStyle === 'italic') || ['I', 'EM'].includes(el.tagName);
                const isUnderline = (s.textDecoration.includes('underline')) || el.tagName === 'U';
                
                // Strip all styles and classes
                el.removeAttribute('style');
                el.removeAttribute('class');
                
                // Legacy font tags
                if (el.tagName === 'FONT') {
                    el.removeAttribute('color'); el.removeAttribute('face'); el.removeAttribute('size');
                }
                
                // Re-apply desired formatting
                if (isBold) el.style.fontWeight = 'bold';
                if (isItalic) el.style.fontStyle = 'italic';
                if (isUnderline) el.style.textDecoration = 'underline';
            });
            return div.innerHTML;
        }

        async function pasteToProblem() {
            try {
                // Force focus on problem content to ensure execCommand works
                problemContentEl.focus();
                
                const clipboardItems = await navigator.clipboard.read();
                let pasted = false;
                
                for (const item of clipboardItems) {
                    if (item.types.includes('text/html')) {
                        const blob = await item.getType('text/html');
                        const htmlText = await blob.text();
                        
                        // Select all and replace with cleaned HTML
                        document.execCommand('selectAll', false, null);
                        document.execCommand('insertHTML', false, cleanHTML(htmlText));
                        pasted = true;
                        break;
                    }
                }
                
                if (!pasted) {
                    const text = await navigator.clipboard.readText();
                    if (text) {
                        document.execCommand('selectAll', false, null);
                        document.execCommand('insertText', false, text);
                    }
                }
                
                // Trigger input to save & update placeholder
                problemContentEl.dispatchEvent(new Event('input'));
                
            } catch (err) { 
                try {
                    // Fallback using simple text API
                    const text = await navigator.clipboard.readText();
                    problemContentEl.focus();
                    document.execCommand('selectAll', false, null);
                    document.execCommand('insertText', false, text);
                    problemContentEl.dispatchEvent(new Event('input'));
                } catch(e) {
                    showModal("Paste Error", "Could not read clipboard. Please paste manually (Ctrl+V)"); 
                }
            }
        }

        // Font Size Logic for Description
        function changeProblemFontSize(delta) {
            problemFontSize = Math.min(32, Math.max(10, problemFontSize + delta));
            applyProblemFontSize();
        }
        function resetProblemFontSize() { problemFontSize = 14; applyProblemFontSize(); }
        function applyProblemFontSize() {
            document.documentElement.style.setProperty('--problem-font-size', problemFontSize + 'px');
            localStorage.setItem("galaxy_problem_font_size", problemFontSize);
        }
        
        // --- Document & Settings ---
        function applyFontSize() {
            document.documentElement.style.setProperty('--editor-font-size', fontSize + 'px');
            editor.getWrapperElement().style.fontSize = fontSize + "px";
            editor.refresh();
            localStorage.setItem("galaxy_font_size", fontSize);
        }

        function loadSettings() {
            isChangingLang = true;
            try {
                const savedFontSize = localStorage.getItem("galaxy_font_size");
                if (savedFontSize) { fontSize = parseInt(savedFontSize); applyFontSize(); }
                
                const savedProblemFontSize = localStorage.getItem("galaxy_problem_font_size");
                if (savedProblemFontSize) { problemFontSize = parseInt(savedProblemFontSize); applyProblemFontSize(); }

                const savedTheme = localStorage.getItem("galaxy_theme");
                if (savedTheme) { 
                    currentTheme = savedTheme; 
                    setTheme(savedTheme, false); // Use setter instead of toggleUI
                } else { 
                    currentTheme = 'classic'; 
                    setTheme('classic', false);
                }
                
                const savedLang = localStorage.getItem("galaxy_lang");
                if(savedLang) { currentLang = savedLang; }
                updateLangUI(currentLang);
                
                // Initialize Projects (This replaces old tab logic)
                initProjects();
                
                // Load saved layout (new)
                const savedLayout = localStorage.getItem("galaxy_layout") || 'right';
                changeLayout(savedLayout);
                
                // Load Last Input
                lastInput = localStorage.getItem('galaxy_last_input') || "";
                
            } catch (err) { console.error("Load settings failed:", err); } 
            finally { isChangingLang = false; }
        }

        function changeFontSize(delta) { fontSize = Math.min(32, Math.max(10, fontSize + delta)); applyFontSize(); }
        function resetFontSize() { fontSize = 14; applyFontSize(); }
        
        // New Theme Setter Logic (Replaces Toggle)
        function setTheme(mode, refresh = true) {
            currentTheme = mode;
            if (mode === 'classic') {
                document.body.setAttribute('data-theme', 'classic');
            } else {
                document.body.removeAttribute('data-theme');
            }
            localStorage.setItem("galaxy_theme", mode);
            updateSettingsDropdownState(); // Update checks
            
            // Auto close dropdown
            const dropdown = document.getElementById('settings-dropdown');
            if(dropdown) {
                dropdown.classList.remove('open');
                dropdown.querySelector('.dropdown-trigger')?.classList.remove('active');
            }
            
            if(refresh) editor.refresh();
        }

        function toggleDropdown(id) {
            const container = document.getElementById(id); if (!container) return;
            const trigger = container.querySelector('.dropdown-trigger');
            document.querySelectorAll('.dropdown-container').forEach(el => { if (el.id !== id) { el.classList.remove('open'); el.querySelector('.dropdown-trigger')?.classList.remove('active'); } });
            container.classList.toggle('open'); if(trigger) trigger.classList.toggle('active');
            
            // If opening settings, ensure checkmarks are correct
            if(id === 'settings-dropdown' && container.classList.contains('open')) {
                updateSettingsDropdownState();
            }
        }

        function selectLanguage(lang) { changeLanguage(lang); toggleDropdown('lang-dropdown'); }
        function selectLayout(layout) { changeLayout(layout); toggleDropdown('layout-dropdown'); } // Generic close

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-container')) {
                document.querySelectorAll('.dropdown-container').forEach(el => { el.classList.remove('open'); el.querySelector('.dropdown-trigger')?.classList.remove('active'); });
            }
        });

        function updateDropdownUI(id, value) {
            const container = document.getElementById(id); if(!container) return;
            // Logic for regular dropdowns
            const items = container.querySelectorAll('.dropdown-item');
            items.forEach(item => {
                if(item.dataset && item.dataset.value) { // Only if data-value exists
                    if (item.dataset.value === value) { 
                        item.classList.add('selected'); 
                        const triggerSpan = container.querySelector('.dropdown-trigger span');
                        if(triggerSpan && id === 'lang-dropdown') triggerSpan.innerText = item.innerText; 
                    } else { item.classList.remove('selected'); }
                }
            });
        }
        
        // --- Problem Settings Logic ---
        
        function saveDefaultCode() {
            const project = projects[activeProjectIndex];
            if(!project) return;
            
            // If Safe Mode (Test Mode) is active
            if(project.testMode) {
                project.defaultCode = editor.getValue();
                project.useDefaultCode = true; // Auto-enable
                saveProjectsToStorage();
                
                updateProblemSettingsUI();
                
                // Close dropdown
                const dropdown = document.getElementById('problem-settings-dropdown');
                if(dropdown) {
                    dropdown.classList.remove('open');
                    dropdown.querySelector('.dropdown-trigger')?.classList.remove('active');
                }
                
                showModal("Saved", "Template saved and Test Mode enabled.");
            } else {
                 // Auto-enable test mode if saving
                project.defaultCode = editor.getValue();
                project.useDefaultCode = true; // Auto-enable reset
                project.testMode = true;       // Auto-enable test mode
                saveProjectsToStorage();
                
                updateProblemSettingsUI();
                
                const dropdown = document.getElementById('problem-settings-dropdown');
                if(dropdown) {
                    dropdown.classList.remove('open');
                    dropdown.querySelector('.dropdown-trigger')?.classList.remove('active');
                }
                
                showModal("Saved", "Template saved and Test Mode enabled.");
            }
        }
        
        function resetToTemplate() {
            const project = projects[activeProjectIndex];
            // Only allow if Safe Mode (Test Mode) AND template exists
            if(!project || !project.testMode || !project.defaultCode) return;
            
            showConfirm("Reset to Template", "This will overwrite your current code with the saved template. Continue?", () => {
                editor.setValue(project.defaultCode);
                // Also ensure UI reflects it
                const dropdown = document.getElementById('problem-settings-dropdown');
                if(dropdown) {
                    dropdown.classList.remove('open');
                    dropdown.querySelector('.dropdown-trigger')?.classList.remove('active');
                }
            });
        }
        
        function toggleUseDefaultCode() {
            const project = projects[activeProjectIndex];
            // Only allow if Safe Mode (Test Mode) AND template exists
            if(!project || !project.testMode || !project.defaultCode) return;
            
            project.useDefaultCode = !project.useDefaultCode;
            saveProjectsToStorage();
            
            updateProblemSettingsUI();
        }
        
        function toggleTestMode() {
            const project = projects[activeProjectIndex];
            if(!project) return;
            
            // Toggle
            project.testMode = !project.testMode;
            
            saveProjectsToStorage();
            updateProblemSettingsUI();
        }
        
        function updateProblemSettingsUI() {
            const project = projects[activeProjectIndex];
            
            const btn = document.querySelector('#problem-settings-dropdown .problem-settings-btn');
            const iconSvg = btn ? btn.querySelector('svg') : null;
            
            const testModeOpt = document.getElementById('enable-test-mode-opt');
            const useOpt = document.getElementById('use-default-code-opt');
            const resetOpt = document.getElementById('reset-template-opt');
            const dropdownContainer = document.getElementById('problem-settings-dropdown');
            
            if(project && project.id === 'main') {
                if(dropdownContainer) dropdownContainer.style.display = 'none';
                return;
            } else {
                if(dropdownContainer) dropdownContainer.style.display = 'inline-block';
            }
            
            if(project) {
                // 1. Update Gear Icon Color
                if(iconSvg) {
                    if(project.testMode) {
                        iconSvg.classList.remove('text-red-500');
                        iconSvg.classList.add('text-green-400'); // Light Green
                        iconSvg.classList.remove('text-gray-400');
                    } else {
                        iconSvg.classList.remove('text-green-400');
                        iconSvg.classList.add('text-red-500'); // Red
                        iconSvg.classList.remove('text-gray-400');
                    }
                }
                
                // 2. Update "Enable Test Mode" Checkmark
                if(testModeOpt) {
                    if(project.testMode) {
                        testModeOpt.classList.add('selected');
                        testModeOpt.querySelector('.check-icon').classList.remove('opacity-0');
                    } else {
                        testModeOpt.classList.remove('selected');
                        testModeOpt.querySelector('.check-icon').classList.add('opacity-0');
                    }
                }
                
                // 3. Logic for Sub-features based on Test Mode
                const isSafe = project.testMode;
                const hasTemplate = !!project.defaultCode;

                // Reset Template Button
                if(isSafe && hasTemplate) {
                     if(resetOpt) resetOpt.classList.remove('disabled');
                } else {
                     if(resetOpt) resetOpt.classList.add('disabled');
                }

                // Reset on Reload Option
                if(isSafe && hasTemplate) {
                    if(useOpt) useOpt.classList.remove('disabled');
                    
                    if(project.useDefaultCode) {
                        useOpt.classList.add('selected');
                        useOpt.querySelector('.check-icon').classList.remove('opacity-0');
                    } else {
                        useOpt.classList.remove('selected');
                        useOpt.querySelector('.check-icon').classList.add('opacity-0');
                    }
                } else {
                    if(useOpt) {
                        useOpt.classList.add('disabled');
                        useOpt.classList.remove('selected');
                        useOpt.querySelector('.check-icon').classList.add('opacity-0');
                    }
                }
            }
        }
        
        // Centralized State Update for Settings Dropdown
        function updateSettingsDropdownState() {
            // Layout Checks
            const rightOpt = document.getElementById('layout-opt-right');
            const bottomOpt = document.getElementById('layout-opt-bottom');
            if(rightOpt && bottomOpt) {
                rightOpt.classList.remove('selected');
                rightOpt.querySelector('.check-icon').classList.add('opacity-0');
                bottomOpt.classList.remove('selected');
                bottomOpt.querySelector('.check-icon').classList.add('opacity-0');
                
                if(currentLayout === 'right') {
                    rightOpt.classList.add('selected');
                    rightOpt.querySelector('.check-icon').classList.remove('opacity-0');
                } else {
                    bottomOpt.classList.add('selected');
                    bottomOpt.querySelector('.check-icon').classList.remove('opacity-0');
                }
            }
            
            // Theme Checks
            const modernOpt = document.getElementById('theme-opt-modern');
            const classicOpt = document.getElementById('theme-opt-classic');
            if(modernOpt && classicOpt) {
                modernOpt.classList.remove('selected');
                modernOpt.querySelector('.check-icon').classList.add('opacity-0');
                classicOpt.classList.remove('selected');
                classicOpt.querySelector('.check-icon').classList.add('opacity-0');
                
                if(currentTheme === 'classic') {
                    classicOpt.classList.add('selected');
                    classicOpt.querySelector('.check-icon').classList.remove('opacity-0');
                } else {
                    modernOpt.classList.add('selected');
                    modernOpt.querySelector('.check-icon').classList.remove('opacity-0');
                }
            }
        }

        function updateLangUI(lang) {
            const filenameLabel = document.getElementById('filename-label');
            const logoIcon = document.getElementById('logo-icon');
            if (lang === 'cpp') {
                if(filenameLabel) filenameLabel.innerText = 'main.cpp';
                if(logoIcon) { logoIcon.innerText = 'C++'; logoIcon.className = "w-7 h-7 rounded bg-blue-600 flex items-center justify-center text-white font-bold text-sm shadow-md"; }
            } else {
                if(filenameLabel) filenameLabel.innerText = 'main.py';
                if(logoIcon) { logoIcon.innerText = 'Py'; logoIcon.className = "w-7 h-7 rounded bg-yellow-500 flex items-center justify-center text-white font-bold text-sm shadow-md"; }
            }
            updateDropdownUI('lang-dropdown', lang);
        }

        function changeLanguage(newLang) {
            if (newLang === currentLang) return;
            isChangingLang = true;
            
            // Save current state for old lang
            saveCurrentProject();
            
            currentLang = newLang; 
            localStorage.setItem("galaxy_lang", newLang);
            updateLangUI(newLang);
            
            // Re-init projects for new lang
            initProjects();
            
            isChangingLang = false;
        }
        
        function undoCode() { editor.undo(); }
        function redoCode() { editor.redo(); }
        
        function toggleComments() {
            const doc = editor.getDoc();
            if (doc._commentsHidden) {
                doc._commentMarkers.forEach(marker => marker.clear()); doc._commentMarkers = []; doc._commentsHidden = false;
            } else {
                const code = doc.getValue(); let regex;
                if (currentLang === 'cpp') regex = /(\/\/[^\n]*)|(\/\*[\s\S]*?\*\/)|("[^"\\]*(?:\\.[^"\\]*)*")/g;
                else regex = /(#.*)|("[^"\\]*(?:\\.[^"\\]*)*")|('[^'\\]*(?:\\.[^'\\]*)*')/g;
                let match;
                while ((match = regex.exec(code)) !== null) {
                    let isComment = false;
                    if (currentLang === 'cpp') { if (match[1] || match[2]) isComment = true; } 
                    else { if (match[1]) isComment = true; }
                    if (isComment) {
                        const marker = doc.markText(doc.posFromIndex(match.index), doc.posFromIndex(match.index + match[0].length), { collapsed: true, atomic: true, inclusiveLeft: true });
                        doc._commentMarkers.push(marker);
                    }
                }
                doc._commentsHidden = true;
            }
            updateCommentButtonUI(doc);
        }
        
        function updateCommentButtonUI(doc) {
            const btn = document.getElementById('toggle-comment-btn'); if (!btn) return;
            if (doc._commentsHidden) {
                btn.innerHTML = `<svg class="w-4 h-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
                btn.title = "Show Comments";
            } else {
                btn.innerHTML = `<svg class="w-4 h-4 text-gray-400 hover:text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;
                btn.title = "Hide Comments";
            }
        }

        editor.addOverlay({ token: function(stream) { if (stream.sol()) { if (stream.eatSpace()) return "indent-guides"; } stream.skipToEnd(); return null; } });
        CodeMirror.registerHelper("hint", "clike", codeHint); CodeMirror.registerHelper("hint", "python", codeHint);

        const outputPre = document.getElementById('output');
        const inputField = document.getElementById('terminal-input');
        const sendInputBtn = document.getElementById('send-input-btn');
        const runBtn = document.getElementById('run-btn');
        const stopBtn = document.getElementById('stop-btn');
        const terminalContainer = document.getElementById('terminal-container');
        const outputWrapper = document.getElementById('output-container-wrapper');
        const terminalResizer = document.getElementById('terminal-resizer');

        if (socket) {
            socket.on('connect', () => { console.log("Connected"); if(statusDot) statusDot.className = "status-dot status-connected"; if(statusText) { statusText.innerText = "Connected"; statusText.className = "text-green-500 text-xs"; }});
            socket.on('disconnect', () => { if(statusDot) statusDot.className = "status-dot status-disconnected"; if(statusText) { statusText.innerText = "Disconnected"; statusText.className = "text-red-500 text-xs"; }});
            socket.on('program_output', (msg) => {
                const loader = document.getElementById('compile-loader'); if (loader) loader.remove();
                const span = document.createElement('span'); 
                span.className = 'terminal-output'; // Removed animate-fade-in-up and inline-block
                span.innerHTML = formatCompilerOutput(msg.data);
                outputPre.appendChild(span); 
                requestAnimationFrame(() => {
                     terminalContainer.scrollTo({ top: terminalContainer.scrollHeight, behavior: 'auto' });
                });
            });
            socket.on('program_status', (msg) => {
                if (msg.status === 'finished') {
                    const endTag = document.createElement('span'); endTag.className = 'text-gray-500 animate-fade-in-up block mt-1'; endTag.innerText = "\n[code end]";
                    outputPre.appendChild(endTag); terminalContainer.scrollTo({ top: terminalContainer.scrollHeight, behavior: 'smooth' }); setRunningState(false);
                } else if (msg.status === 'error') {
                    const loader = document.getElementById('compile-loader'); if (loader) loader.remove(); setRunningState(false);
                }
            });
        }
        
        function formatCompilerOutput(text) {
            let safeText = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            safeText = safeText.replace(/(\w+\.\w+:\d+:\d+:)(\s*error:)/g, '<span class="terminal-path">$1</span><span class="terminal-error">$2</span>');
            safeText = safeText.replace(/(\w+\.\w+:\d+:\d+:)(\s*warning:)/g, '<span class="terminal-path">$1</span><span class="terminal-warning">$2</span>');
            safeText = safeText.replace(/(\w+\.\w+:\d+:\d+:)(\s*note:)/g, '<span class="terminal-path">$1</span><span class="terminal-note">$2</span>');
            safeText = safeText.replace(/(fatal error:)/g, '<span class="terminal-error">$1</span>');
            safeText = safeText.replace(/(Traceback \(most recent call last\):)/g, '<span class="terminal-error">$1</span>');
            safeText = safeText.replace(/(File ".*", line \d+.*)/g, '<span class="terminal-path">$1</span>');
            safeText = safeText.replace(/^(\w+Error:)/gm, '<span class="terminal-error">$1</span>');
            return safeText;
        }

        function setRunningState(running) {
            isRunning = running;
            if (running) {
                runBtn.classList.add('hidden'); stopBtn.classList.remove('hidden'); inputField.disabled = false; sendInputBtn.disabled = false; inputField.focus(); 
                outputPre.innerHTML = '<div id="compile-loader" class="mb-2 text-left animate-fade-in-up"><span class="text-yellow-500 font-bold text-xs flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span>[Compiling & Running...]</span><div class="w-40 h-1 bg-gray-700 mt-2 rounded overflow-hidden relative loading-container shadow-lg"><div class="absolute top-0 left-0 h-full bg-yellow-500 animate-loading-bar"></div></div></div>';
            } else {
                runBtn.classList.remove('hidden'); stopBtn.classList.add('hidden'); inputField.disabled = true; sendInputBtn.disabled = true; inputField.value = "";
            }
        }

        function runCode() { if(socket) { setRunningState(true); socket.emit('run_code_v2', { code: editor.getValue(), lang: currentLang }); } else { showModal("Error", "Cannot connect to server"); } }
        function stopCode() { if(socket) socket.emit('stop_code'); const loader = document.getElementById('compile-loader'); if (loader) loader.remove(); setRunningState(false); }
        function clearOutput() { outputPre.innerHTML = ""; }
        function focusInput() { if (isRunning) inputField.focus(); }
        function copyCode() { editor.execCommand('selectAll'); editor.focus(); navigator.clipboard.writeText(editor.getValue()).then(() => { const btn = document.getElementById('copy-btn'); const originalContent = btn.innerHTML; btn.innerHTML = `<svg class="w-4 h-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`; setTimeout(() => { btn.innerHTML = originalContent; }, 2000); }); }
        function clearAllCode() { showConfirm("Clear All", "Are you sure you want to clear all code? This action cannot be undone.", () => { editor.setValue(""); clearOutput(); }); }
        function insertHelloWorld(auto = false) { 
            if (!auto) {
                showConfirm("Insert Template", "Clear current code and insert Hello World?", () => {
                    if (currentLang === 'cpp') { editor.setValue('#include <iostream>\nusing namespace std;\n\nint main() {\n    cout << "Hello World" << endl;\n    return 0;\n}'); } else { editor.setValue('print("Hello Galaxy Python!")\n\n# Try typing something\nname = input("Please enter your name: ")\nprint(f"Nice to meet you, {name}!")'); }
                });
                return;
            }
             if (currentLang === 'cpp') { editor.setValue('#include <iostream>\nusing namespace std;\n\nint main() {\n    cout << "Hello World" << endl;\n    return 0;\n}'); } else { editor.setValue('print("Hello Galaxy Python!")\n\n# Try typing something\nname = input("Please enter your name: ")\nprint(f"Nice to meet you, {name}!")'); }
        }
        async function clearAndPaste() { 
            showConfirm("Paste", "Clear all code and paste from clipboard?", async () => { 
                try { 
                    const text = await navigator.clipboard.readText(); 
                    if (text) {
                        editor.setValue(text); 
                        clearOutput();
                    } else {
                        showModal("Notice", "Clipboard is empty.");
                    }
                } catch (err) { 
                    showModal("Paste Error", "Could not access clipboard. Please ensure you have granted permission or paste manually (Ctrl+V)."); 
                } 
            }); 
        }

        function downloadCode() {
            const code = editor.getValue(); let filename = prompt("Enter file name:", "main");
            if (filename === null) return; if (filename.trim() === "") filename = "main";
            let ext = currentLang === 'cpp' ? '.cpp' : '.py'; if (!filename.endsWith(ext)) filename += ext;
            const blob = new Blob([code], { type: "text/plain" }); const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        function sendInput() { 
            if (!isRunning || !socket) return; 
            const text = inputField.value; 
            
            // Store Last Input Logic
            lastInput = text;
            localStorage.setItem('galaxy_last_input', text);
            
            const echo = document.createElement('span'); 
            echo.className = 'terminal-input-echo animate-fade-in-up block whitespace-pre-wrap'; 
            echo.innerText = text + '\n'; 
            outputPre.appendChild(echo); 
            socket.emit('send_input', { input: text }); 
            inputField.value = ""; 
            terminalContainer.scrollTo({ top: terminalContainer.scrollHeight, behavior: 'smooth' }); 
            inputField.focus(); 
        }
        
        function fillLastInput() {
            if(lastInput !== null && lastInput !== undefined) {
                inputField.value = lastInput;
                inputField.focus();
            }
        }
        
        inputField.addEventListener('keydown', (e) => { if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); sendInput(); } });
        
        // --- Smart Resizing Logic ---
        let activeResizer = null;
        let isResizingProcess = false; 
        
        problemResizer.addEventListener('mousedown', (e) => startResize(e, 'problem'));
        terminalResizer.addEventListener('mousedown', (e) => startResize(e, 'terminal'));
        problemResizer.addEventListener('touchstart', (e) => startResize(e, 'problem'));
        terminalResizer.addEventListener('touchstart', (e) => startResize(e, 'terminal'));

        function startResize(e, type) {
            if (e.type === 'mousedown' || e.type === 'touchstart') {
                if (e.cancelable && e.type === 'mousedown') e.preventDefault();
            }
            activeResizer = type;
            const targetResizer = type === 'problem' ? problemResizer : terminalResizer;
            targetResizer.classList.add('resizing');
            
            document.body.style.cursor = (type === 'problem' || currentLayout === 'right') ? 'col-resize' : 'row-resize';
            
            if (type === 'problem') problemContainer.style.transition = 'none';
            if (type === 'terminal') outputWrapper.style.transition = 'none';
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResize);
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', stopResize);
        }

        function handleTouchMove(e) {
            if (!activeResizer) return;
            if (e.cancelable) e.preventDefault();
            handleMouseMove(e.touches[0]); 
        }

        function handleMouseMove(e) {
            if (!activeResizer) return;
            if (isResizingProcess) return;
            isResizingProcess = true;
            requestAnimationFrame(() => {
                performResize(e.clientX, e.clientY);
                isResizingProcess = false;
            });
        }
        
        function performResize(clientX, clientY) {
            const containerRect = document.getElementById('main-container').getBoundingClientRect();
            const centerAreaRect = centerArea.getBoundingClientRect();
            
            if (activeResizer === 'problem') {
                let newWidthPx = clientX - containerRect.left;
                let newWidthPercent = (newWidthPx / containerRect.width) * 100;
                newWidthPercent = Math.max(10, Math.min(50, newWidthPercent)); 
                problemContainer.style.width = `${newWidthPercent}%`;
                
            } else if (activeResizer === 'terminal') {
                if (currentLayout === 'bottom') {
                    let newHeightPercent = ((clientY - centerAreaRect.top) / centerAreaRect.height) * 100;
                    newHeightPercent = Math.max(10, Math.min(90, newHeightPercent));
                    editorContainer.style.flex = `0 0 ${newHeightPercent}%`; 
                    outputWrapper.style.flex = `0 0 ${100 - newHeightPercent}%`;
                } else {
                    let newEditorWidthPx = clientX - centerAreaRect.left;
                    let newWidthPercent = (newEditorWidthPx / centerAreaRect.width) * 100;
                    newWidthPercent = Math.max(10, Math.min(90, newWidthPercent));
                    editorContainer.style.flex = `0 0 ${newWidthPercent}%`; 
                    outputWrapper.style.flex = `0 0 ${100 - newWidthPercent}%`;
                }
            }
        }

        function stopResize() { 
            if(activeResizer) {
                const targetResizer = activeResizer === 'problem' ? problemResizer : terminalResizer;
                targetResizer.classList.remove('resizing');
                
                if (activeResizer === 'problem') problemContainer.style.transition = '';
                if (activeResizer === 'terminal') outputWrapper.style.transition = '';
            }
            activeResizer = null; 
            document.body.style.cursor = 'default'; 
            document.removeEventListener('mousemove', handleMouseMove); 
            document.removeEventListener('mouseup', stopResize);
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', stopResize);
            editor.refresh();
        }
        
        function changeLayout(mode) {
            currentLayout = mode;
            if (mode === 'bottom') {
                centerArea.classList.remove('flex-row'); centerArea.classList.add('flex-col');
                terminalResizer.className = 'resizer-split resizer-row'; 
                terminalResizer.title = "Drag to resize height";
                editorContainer.style.flex = '0 0 70%'; outputWrapper.style.flex = '0 0 30%';
            } else {
                centerArea.classList.remove('flex-col'); centerArea.classList.add('flex-row');
                terminalResizer.className = 'resizer-split resizer-col';
                terminalResizer.title = "Drag to resize width";
                editorContainer.style.flex = '0 0 70%'; outputWrapper.style.flex = '0 0 30%';
            }
            // Close dropdown manually since we are using generic close
            const dropdown = document.getElementById('settings-dropdown');
            if(dropdown) {
                dropdown.classList.remove('open');
                dropdown.querySelector('.dropdown-trigger')?.classList.remove('active');
            }
            // Update UI state
            updateSettingsDropdownState(); // Fixed name to match the check-icon update function
            localStorage.setItem("galaxy_layout", mode);
            editor.refresh();
        }

        // --- Viewport Logic for Mobile Keyboard Fix ---
        if (window.visualViewport) {
            const handleViewportResize = () => {
                document.body.style.height = window.visualViewport.height + 'px';
                window.scrollTo(0, 0);
            };
            window.visualViewport.addEventListener('resize', handleViewportResize);
            window.visualViewport.addEventListener('scroll', handleViewportResize);
            handleViewportResize();
        }

        // Initial Load
        loadSettings();

    </script>
</body>
</html>